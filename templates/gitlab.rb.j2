# URL
{% if gitlab_web_port is defined %}
external_url '{{ _url_scheme }}://{{ gitlab_hostname }}:{{ gitlab_web_port }}'
{% else %}
external_url '{{ _url_scheme }}://{{ gitlab_hostname }}'
{% endif %}
registry_external_url '{{ _url_scheme }}://{{ gitlab_hostname }}:{{ gitlab_registry_port }}'
{% if gitlab_ssh_port is defined %}
gitlab_rails['gitlab_shell_ssh_port'] = {{ gitlab_ssh_port }}
{% endif %}

# HTTPS
{% if gitlab_https_enable %}
    {% if gitlab_letsencrypt_enable %}
letsencrypt['enable'] = true
    {% else %}
letsencrypt['enable'] = false
    {% endif %}
{% endif %}

# Application server
{% if gitlab_unicorn_force %}
puma['enable'] = false
unicorn['enable'] = true
    {% if gitlab_workers is defined %}
unicorn['worker_processes'] = {{ gitlab_workers }}
    {% endif %}
{% else %}
    {% if gitlab_workers is defined %}
puma['worker_processes'] = {{ gitlab_workers }}
    {% endif %}
    {% if gitlab_min_threads is defined %}
puma['min_threads'] = {{ gitlab_min_threads }}
    {% endif %}
    {% if gitlab_max_threads is defined %}
puma['max_threads'] = {{ gitlab_max_threads }}
    {% endif %}
{% endif %}
{% if gitlab_unicorn_workers is defined %}
unicorn['worker_processes'] = {{ gitlab_unicorn_workers }}
{% endif %}

# Monitoring
{% if gitlab_monitoring_whitelist is defined %}
gitlab_rails['monitoring_whitelist'] = ['{{ gitlab_monitoring_whitelist | join("', '") }}']
{% endif %}

# Outgoing emails
{% if gitlab_email_enabled or gitlab_email_enable %}
gitlab_rails['gitlab_email_enabled'] = true
    {% if gitlab_email_from_mailbox is defined %}
gitlab_rails['gitlab_email_from'] = '{{ gitlab_email_from_mailbox }}'
    {% endif %}
    {% if gitlab_email_from_display_name is defined %}
gitlab_rails['gitlab_email_display_name'] = '{{ gitlab_email_from_display_name }}'
    {% endif %}
    {% if gitlab_email_reply_to_mailbox is defined %}
gitlab_rails['gitlab_email_reply_to'] = '{{ gitlab_email_reply_to_mailbox }}'
    {% endif %}
gitlab_rails['smtp_enable'] = true
    {% if gitlab_email_smtp_server_host is defined %}
gitlab_rails['smtp_address'] = '{{ gitlab_email_smtp_server_host }}'
    {% endif %}
    {% if gitlab_email_smtp_server_port is defined %}
gitlab_rails['smtp_port'] = {{ gitlab_email_smtp_server_port }}
    {% endif %}
    {% if gitlab_email_smtp_transport_security is defined %}
        {% if gitlab_email_smtp_transport_security == 'tls' %}
gitlab_rails['smtp_tls'] = true
gitlab_rails['smtp_enable_starttls_auto'] = false
        {% elif gitlab_email_smtp_transport_security == 'starttls' %}
gitlab_rails['smtp_tls'] = false
gitlab_rails['smtp_enable_starttls_auto'] = true
        {% endif %}
        {% if gitlab_email_smtp_verify_server_cert %}
gitlab_rails['smtp_openssl_verify_mode'] = 'peer'
        {% else %}
gitlab_rails['smtp_openssl_verify_mode'] = 'none'
        {% endif %}
        {% if gitlab_email_smtp_ca_cert is defined %}
gitlab_rails['smtp_ca_file'] = '/etc/ssl/certs/smtp.crt.pem'
        {% endif %}
    {% else %}
gitlab_rails['smtp_tls'] = false
gitlab_rails['smtp_enable_starttls_auto'] = false
    {% endif %}
    {% if gitlab_email_smtp_user_auth_method is defined %}
gitlab_rails['smtp_authentication'] = '{{ gitlab_email_smtp_user_auth_method }}'
    {% endif %}
    {% if gitlab_email_smtp_user_name is defined %}
gitlab_rails['smtp_user_name'] = '{{ gitlab_email_smtp_user_name }}'
    {% endif %}
    {% if gitlab_email_smtp_user_password is defined %}
gitlab_rails['smtp_password'] = '{{ gitlab_email_smtp_user_password }}'
    {% endif %}
{% else %}
gitlab_rails['gitlab_email_enabled'] = false
{% endif %}

# Backup
{% if gitlab_backup_keep_time is defined %}
gitlab_rails['backup_keep_time'] = {{ gitlab_backup_keep_time }}
{% endif %}
{% if gitlab_backup_upload_enable %}
    {% if gitlab_backup_upload_type == 's3' %}
gitlab_rails['backup_upload_connection'] = {
  'provider' => 'AWS',
        {% if gitlab_backup_upload_s3_endpoint is defined %}
  'endpoint' => '{{ gitlab_backup_upload_s3_endpoint }}',
        {% endif %}
        {% if gitlab_backup_upload_s3_region is defined %}
  'region' => '{{ gitlab_backup_upload_s3_region }}',
        {% endif %}
        {% if gitlab_backup_upload_s3_path_style_enable is defined %}
  'path_style' => {{ 'true' if gitlab_backup_upload_s3_path_style_enable else 'false' }},
        {% endif %}
  'aws_access_key_id' => '{{ gitlab_backup_upload_s3_access_key_id | mandatory }}',
  'aws_secret_access_key' => '{{ gitlab_backup_upload_s3_secret_access_key | mandatory }}'
}
gitlab_rails['backup_upload_remote_directory'] = '{{ gitlab_backup_upload_s3_bucket | mandatory }}'
    {% endif %}
{% endif %}
